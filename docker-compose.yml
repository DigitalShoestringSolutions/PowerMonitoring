version: "2"

services:
    timeseries-db:
        extends:
            file: timeseries_datastorage/app.yml
            service: db
        networks:
            internal:
                aliases:
                    - timeseries-db.docker.local
        restart: unless-stopped
        depends_on:
            - "mqtt_broker"
        labels:
            net.digitalshoestring.solution: "power-monitoring"
            net.digitalshoestring.function: "application"

    timeseries-db-input:
        extends:
            file: timeseries_datastorage/app.yml
            service: telegraf
        networks:
            internal:
                aliases:
                    - timeseries-input.docker.local
        restart: unless-stopped
        depends_on:
            - "timeseries-db"
            - "mqtt_broker"
        labels:
            net.digitalshoestring.solution: "power-monitoring"
            net.digitalshoestring.function: "application"
    dashboard:
        extends:
            file: dashboards/app.yml
            service: app
        networks:
            internal:
                aliases:
                    - dashboards.docker.local
        restart: unless-stopped
        depends_on:
            - "mqtt_broker"
        labels:
            net.digitalshoestring.solution: "power-monitoring"
            net.digitalshoestring.function: "application"
 
   
    current-sensing:
        extends:
            file: current_sensing/app.yml
            service: app
        networks:
            internal:
                aliases:
                    - current-sensing.docker.local
        restart: unless-stopped
        depends_on:
            - "mqtt_broker"
        labels:
            net.digitalshoestring.solution: "power-monitoring"
            net.digitalshoestring.function: "application"
 
    graph:
        extends: 
            file: graph/app.yml
            service: app
        networks:
            internal:
                aliases:
                    - graph.docker.local
        restart: unless-stopped
        depends_on: 
            - "timeseries-db"
        labels:
            net.digitalshoestring.solution: "power-monitoring"
            net.digitalshoestring.function: "application"

    analysis:
        extends:
            file: analysis/app.yml
            service: app
        networks:
            internal:
                aliases:
                    - analysis.docker.local
        restart: unless-stopped       
        depends_on: 
            - "timeseries-db"
        labels:
            net.digitalshoestring.solution: "power-monitoring"
            net.digitalshoestring.function: "application"

 
    mqtt_broker:
        extends:
            file: mqtt_broker/app.yml
            service: app
        restart: unless-stopped
        networks:
            internal:
                aliases:
                    - mqtt.docker.local
        depends_on: 
            - "alloy"
        labels:
            net.digitalshoestring.solution: "power-monitoring"
            net.digitalshoestring.function: "infrastructure"

    alloy:
        image: grafana/alloy:v1.2.0
        command: run --server.http.listen-addr=0.0.0.0:12345 /etc/alloy/config.alloy
        volumes:
        - ./logging/config.alloy:/etc/alloy/config.alloy:ro
        - /var/run/docker.sock:/var/run/docker.sock
        ports:
        - 12345:12345
        networks:
            internal:
                aliases:
                    - alloy.docker.local
        labels:
            net.digitalshoestring.solution: "power-monitoring"
            net.digitalshoestring.function: "infrastructure"
            net.digitalshoestring.log: "true"

    loki:
        image: grafana/loki:3.1.0
        user: $CURRENT_UID
        ports:
        - "3100:3100"
        command: -config.file=/etc/loki/config.yml
        volumes:
          - ./logging/data:/data
          - ./logging/loki_config.yml:/etc/loki/config.yml
        networks:
            internal:
                aliases:
                    - loki.docker.local
        labels:
            net.digitalshoestring.solution: "power-monitoring"
            net.digitalshoestring.function: "infrastructure"
            net.digitalshoestring.log: "true"

networks:
     internal:
         name: shoestring-internal
